<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zipinfo.project.admin.model.mapper.ManagementMapper">

  <!-- 전체 회원 조회 (삭제되지 않은 회원) -->
  <select id="selectAllMembers" resultType="com.zipinfo.project.member.model.dto.Member">
    SELECT MEMBER_NO,
           MEMBER_EMAIL,
           MEMBER_NICKNAME,
           MEMBER_NAME,
           MEMBER_AUTH,
           ENROLL_DATE,
           MEMBER_DEL_FL
      FROM MEMBER
     WHERE MEMBER_DEL_FL = 'N'
     ORDER BY MEMBER_NO DESC
  </select>

  <!-- 삭제된 회원 조회 (논리 삭제된 회원만) -->
  <select id="selectDeletedMembers" resultType="com.zipinfo.project.member.model.dto.Member">
    SELECT MEMBER_NO,
           MEMBER_EMAIL,
           MEMBER_NICKNAME,
           MEMBER_NAME,
           MEMBER_AUTH,
           ENROLL_DATE,
           MEMBER_DEL_FL
      FROM MEMBER
     WHERE MEMBER_DEL_FL = 'Y'
  </select>

  <!-- 회원 권한 변경 -->
  <update id="updateMemberAuth">
    UPDATE MEMBER
       SET MEMBER_AUTH = #{authId}
     WHERE MEMBER_NO = #{memberNo}
  </update>

  <!-- 회원 삭제 (soft delete 처리) -->
  <update id="deleteMember">
    UPDATE MEMBER
       SET MEMBER_DEL_FL = 'Y'
     WHERE MEMBER_NO = #{memberNo}
  </update>

  <!-- 회원 복원 -->
  <update id="restoreMember">
    UPDATE MEMBER
       SET MEMBER_DEL_FL = 'N'
     WHERE MEMBER_NO = #{memberNo}
  </update>

  <!-- 중개인 신청 회원 목록 조회 -->
  <select id="selectBrokerApplications" resultType="com.zipinfo.project.admin.model.dto.BrokerApplicationDTO">
  SELECT
    m.MEMBER_NO AS memberNumber,
    m.MEMBER_EMAIL AS memberId,
    m.ENROLL_DATE AS joinDate,
    m.MEMBER_AUTH AS memberRole,
    (SELECT COUNT(*) FROM BOARD WHERE MEMBER_NO = m.MEMBER_NO) AS postCount,
    CASE
      WHEN m.MEMBER_AUTH = 2 THEN '신청중'
      WHEN m.MEMBER_AUTH = 3 THEN '승인됨'
      ELSE '기타'
    END AS applicationStatus
  FROM MEMBER m
  WHERE m.MEMBER_AUTH = 2
</select>


  <!-- 회원 권한 변경 -->
  <update id="updateMemberRole" parameterType="map">
    UPDATE MEMBER
    SET MEMBER_AUTH = #{authId}
    WHERE MEMBER_NO = #{memberNumber}
  </update>


</mapper>
