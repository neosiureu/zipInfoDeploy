<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zipinfo.project.board.model.mapper.AnnounceMapper">

  <!-- 기본 Board 매핑 -->
  <resultMap id="BoardResultMap" type="com.zipinfo.project.board.model.dto.Board">
    <id property="boardNo" column="BOARD_NO"/>
    <result property="boardTitle" column="BOARD_TITLE"/>
    <result property="boardContent" column="BOARD_CONTENT"/>
    <result property="boardSubject" column="BOARD_SUBJECT"/>
    <result property="readCount" column="READ_COUNT"/>
    <result property="memberNo" column="MEMBER_NO"/>
    <result property="boardWriteDate" column="BOARD_WRITE_DATE"/>
    <!-- BOARD_UPDATE_DATE 제거 -->
    <result property="memberNickname" column="MEMBER_NICKNAME"/>
    <result property="memberAuth" column="MEMBER_AUTH"/>
  </resultMap>

  <!-- 게시글 등록 -->
  <insert id="insertBoard" parameterType="com.zipinfo.project.board.model.dto.Board" useGeneratedKeys="true" keyProperty="boardNo" keyColumn="BOARD_NO">
    INSERT INTO "BOARD" (
      BOARD_TITLE, BOARD_CONTENT, BOARD_SUBJECT, MEMBER_NO, TOWN_NO
    ) VALUES (
      #{boardTitle}, #{boardContent}, #{boardSubject}, #{memberNo}, #{townNo}
    )
  </insert>

  <!-- 게시글 수정 -->
  <update id="updateBoard" parameterType="com.zipinfo.project.board.model.dto.Board">
    UPDATE "BOARD"
    SET BOARD_TITLE = #{boardTitle},
        BOARD_CONTENT = #{boardContent},
        BOARD_UPDATE_DATE = SYSDATE
    WHERE BOARD_NO = #{boardNo}
  </update>

  <!-- 게시글 삭제 (논리삭제) -->
  <update id="deleteBoard" parameterType="map">
    UPDATE "BOARD"
    SET BOARD_DEL_FL = 'Y'
    WHERE BOARD_NO = #{boardNo}
  </update>

  <!-- 이미지 삽입 -->
  <insert id="insertBoardImage">
    INSERT INTO "BOARD_IMG" (IMG_NO, BOARD_NO, IMG_RENAME, IMG_ORDER)
    VALUES (BOARD_IMG_SEQ.NEXTVAL, #{param1}, #{param2}, #{param3})
  </insert>

  <!-- 이미지 존재 확인 -->
  <select id="countImageByBoardNoAndOrder" resultType="int">
    SELECT COUNT(*)
    FROM "BOARD_IMG"
    WHERE BOARD_NO = #{param1}
      AND IMG_ORDER = #{param2}
  </select>

  <!-- 이미지 수정 -->
  <update id="updateBoardImage">
    UPDATE "BOARD_IMG"
    SET IMG_RENAME = #{param2}
    WHERE BOARD_NO = #{param1}
      AND IMG_ORDER = #{param3}
  </update>

  <!-- 이미지 삭제 -->
  <delete id="deleteBoardImage">
    DELETE FROM "BOARD_IMG"
    WHERE BOARD_NO = #{param1}
      AND IMG_ORDER = #{param2}
  </delete>

  <!-- 게시글 목록 조회 (페이징) -->
  <select id="selectBoardList" resultMap="BoardResultMap" parameterType="map">
    <![CDATA[
      SELECT
        b.BOARD_NO,
        b.BOARD_TITLE,
        b.BOARD_CONTENT,
        b.BOARD_SUBJECT,
        b.READ_COUNT,
        b.MEMBER_NO,
        TO_CHAR(b.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_WRITE_DATE,
        -- BOARD_UPDATE_DATE 제거
        m.MEMBER_NICKNAME,
        m.MEMBER_AUTH
      FROM BOARD b
      LEFT JOIN MEMBER m ON b.MEMBER_NO = m.MEMBER_NO
      WHERE b.BOARD_DEL_FL = 'N'
        AND b.BOARD_SUBJECT = #{boardSubject}
      ORDER BY b.BOARD_NO DESC
      OFFSET (#{cp} - 1) * 10 ROWS FETCH NEXT 10 ROWS ONLY
    ]]>
  </select>

  <!-- 게시글 검색 목록 -->
  <select id="searchList" resultMap="BoardResultMap" parameterType="map">
    <![CDATA[
      SELECT
        b.BOARD_NO, b.BOARD_TITLE, b.BOARD_CONTENT, b.BOARD_SUBJECT, b.READ_COUNT,
        b.MEMBER_NO,
        TO_CHAR(b.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_WRITE_DATE,
        -- BOARD_UPDATE_DATE 제거
        m.MEMBER_NICKNAME,
        m.MEMBER_AUTH
      FROM "BOARD" b
      LEFT JOIN "MEMBER" m ON b.MEMBER_NO = m.MEMBER_NO
      WHERE b.BOARD_DEL_FL = 'N'
        AND b.BOARD_SUBJECT = #{boardSubject}
        <choose>
          <when test="key == 't'">
            AND b.BOARD_TITLE LIKE '%' || #{query} || '%'
          </when>
          <when test="key == 'c'">
            AND b.BOARD_CONTENT LIKE '%' || #{query} || '%'
          </when>
          <when test="key == 'tc'">
            AND (b.BOARD_TITLE LIKE '%' || #{query} || '%'
              OR b.BOARD_CONTENT LIKE '%' || #{query} || '%')
          </when>
          <otherwise>
            AND b.MEMBER_NO IN (
              SELECT MEMBER_NO FROM "MEMBER"
              WHERE MEMBER_NICKNAME LIKE '%' || #{query} || '%'
            )
          </otherwise>
        </choose>
      ORDER BY b.BOARD_NO DESC
      OFFSET (#{cp} - 1) * 10 ROWS FETCH NEXT 10 ROWS ONLY
    ]]>
  </select>

  <!-- 조회수 증가 -->
  <update id="increaseViewCount" parameterType="int">
    UPDATE "BOARD"
    SET READ_COUNT = READ_COUNT + 1
    WHERE BOARD_NO = #{boardNo}
  </update>

</mapper>
