<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zipinfo.project.board.model.mapper.AnnounceMapper">

  <!-- Board(공지사항) DTO와 컬럼 매핑 -->
  <resultMap id="BoardResultMap" type="com.zipinfo.project.board.model.dto.Board">
    <id property="boardNo" column="ANNOUNCE_NO"/>
    <result property="announceTitle" column="ANNOUNCE_TITLE"/>
    <result property="announce" column="ANNOUNCE"/>
    <result property="announceWriteDate" column="ANNOUNCE_WRITE_DATE"/>
    <result property="announceReadCount" column="ANNOUNCE_READ_COUNT"/>
    <result property="announceDelFl" column="ANNOUNCE_DEL_FL"/>
    <result property="memberNo" column="MEMBER_NO"/>
  </resultMap>

  <!-- 공지사항 게시글 등록 -->
  <insert id="insertBoard" parameterType="com.zipinfo.project.board.model.dto.Board" useGeneratedKeys="true" keyProperty="boardNo" keyColumn="ANNOUNCE_NO">
    INSERT INTO ANNOUNCE (
      ANNOUNCE_NO,
      ANNOUNCE_TITLE,
      ANNOUNCE,
      ANNOUNCE_WRITE_DATE,
      ANNOUNCE_READ_COUNT,
      ANNOUNCE_DEL_FL,
      MEMBER_NO
    ) VALUES (
      ANNOUNCE_SEQ.NEXTVAL,
      #{announceTitle},
      #{announce},
      SYSDATE,
      0,
      'N',
      #{memberNo}
    )
  </insert>

  <!-- 공지사항 게시글 수정 -->
  <update id="updateBoard" parameterType="com.zipinfo.project.board.model.dto.Board">
    UPDATE ANNOUNCE
    SET
      ANNOUNCE_TITLE = #{announceTitle},
      ANNOUNCE = #{announce}
    WHERE ANNOUNCE_NO = #{boardNo}
  </update>

  <!-- 공지사항 게시글 삭제 (논리삭제) -->
  <update id="deleteBoard" parameterType="map">
    UPDATE ANNOUNCE
    SET ANNOUNCE_DEL_FL = 'Y'
    WHERE ANNOUNCE_NO = #{boardNo}
  </update>

  <!-- 공지사항 게시글 목록 조회 (페이징 처리) -->
  <select id="selectBoardList" resultMap="BoardResultMap" parameterType="map">
    SELECT
      ANNOUNCE_NO,
      ANNOUNCE_TITLE,
      ANNOUNCE,
      TO_CHAR(ANNOUNCE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS ANNOUNCE_WRITE_DATE,
      ANNOUNCE_READ_COUNT,
      ANNOUNCE_DEL_FL,
      MEMBER_NO
    FROM ANNOUNCE
    WHERE ANNOUNCE_DEL_FL = 'N'
    ORDER BY ANNOUNCE_NO DESC
    OFFSET (#{cp} - 1) * 10 ROWS FETCH NEXT 10 ROWS ONLY
  </select>

  <!-- 공지사항 게시글 검색 목록 -->
  <select id="searchList" resultMap="BoardResultMap" parameterType="map">
    SELECT
      ANNOUNCE_NO,
      ANNOUNCE_TITLE,
      ANNOUNCE,
      TO_CHAR(ANNOUNCE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS ANNOUNCE_WRITE_DATE,
      ANNOUNCE_READ_COUNT,
      ANNOUNCE_DEL_FL,
      MEMBER_NO
    FROM ANNOUNCE
    WHERE ANNOUNCE_DEL_FL = 'N'
    <choose>
      <when test="key == 't'">
        AND ANNOUNCE_TITLE LIKE '%' || #{query} || '%'
      </when>
      <when test="key == 'c'">
        AND ANNOUNCE LIKE '%' || #{query} || '%'
      </when>
      <when test="key == 'tc'">
        AND (ANNOUNCE_TITLE LIKE '%' || #{query} || '%' OR ANNOUNCE LIKE '%' || #{query} || '%')
      </when>
      <otherwise>
        AND MEMBER_NO IN (
          SELECT MEMBER_NO FROM MEMBER
          WHERE MEMBER_NICKNAME LIKE '%' || #{query} || '%'
        )
      </otherwise>
    </choose>
    ORDER BY ANNOUNCE_NO DESC
    OFFSET (#{cp} - 1) * 10 ROWS FETCH NEXT 10 ROWS ONLY
  </select>

  <!-- 조회수 증가 -->
  <update id="increaseViewCount" parameterType="int">
    UPDATE ANNOUNCE
    SET ANNOUNCE_READ_COUNT = ANNOUNCE_READ_COUNT + 1
    WHERE ANNOUNCE_NO = #{boardNo}
  </update>

  <!-- 공지사항 게시글 단일 조회 -->
  <select id="selectOne" resultMap="BoardResultMap" parameterType="map">
    SELECT
      ANNOUNCE_NO,
      ANNOUNCE_TITLE,
      ANNOUNCE,
      TO_CHAR(ANNOUNCE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS ANNOUNCE_WRITE_DATE,
      ANNOUNCE_READ_COUNT,
      ANNOUNCE_DEL_FL,
      MEMBER_NO
    FROM ANNOUNCE
    WHERE ANNOUNCE_NO = #{boardNo}
      AND ANNOUNCE_DEL_FL = 'N'
  </select>

</mapper>
