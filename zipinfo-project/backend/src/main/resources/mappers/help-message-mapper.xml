<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zipinfo.project.admin.model.mapper.HelpMessageMapper">

  <!-- 전체 문의 목록 조회 -->
  <select id="selectAllMessages">
  SELECT 
    MESSAGE_NO,
    MESSAGE_TITLE,
    MESSAGE_CONTENT,
    MESSAGE_WRITE_DATE,
    MESSAGE_READ_FL,
    USER_DEL_FL,
    ADMIN_DEL_FL,
    SENDER_NO,
    RECEIVER_NO,
    REPLY_YN,
    NULL AS FILE_NO,
    NULL AS FILE_URL,
    NULL AS FILE_ORIGIN_NAME,
    NULL AS FILE_RENAME
  FROM HELP_MESSAGE
  WHERE USER_DEL_FL = 'N' 
  ORDER BY MESSAGE_NO DESC
</select>

  <!-- 특정 문의 상세 조회 -->
  <select id="selectMessageById" >
  SELECT 
    hm.MESSAGE_NO AS messageNo,
    hm.MESSAGE_TITLE AS messageTitle,
    hm.MESSAGE_CONTENT AS messageContent,
    TO_CHAR(hm.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS messageWriteDate,
    hm.MESSAGE_READ_FL AS messageReadFl,
    hm.USER_DEL_FL AS userDelFl,
    hm.ADMIN_DEL_FL AS adminDelFl,
    hm.SENDER_NO AS senderNo,
    hm.RECEIVER_NO AS receiverNo,
    hm.REPLY_YN AS replyYn,
    mf.FILE_NO AS fileNo,
    mf.FILE_URL AS fileUrl,
    mf.FILE_ORIGIN_NAME AS fileOriginName,
    mf.FILE_RENAME AS fileRename,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  WHERE hm.MESSAGE_NO = #{messageNo}
</select>






  <!-- 답변 등록용 (INSERT) -->
  <insert id="insertReply">
    INSERT INTO HELP_MESSAGE (
      MESSAGE_NO,
      MESSAGE_TITLE,
      MESSAGE_CONTENT,
      MESSAGE_WRITE_DATE,
      MESSAGE_READ_FL,
      USER_DEL_FL,
      ADMIN_DEL_FL,
      REPLY_YN,
      SENDER_NO,
      RECEIVER_NO,
      INQUIRED_NO
    ) VALUES (
      SEQ_MESSAGE_NO.NEXTVAL,
      '답변',
      #{messageContent},
      SYSDATE,
      'N',
      'N',
      'N',
      'N',
      #{senderNo},
      #{receiverNo},
      #{inquiredNo}
    )
  </insert>

  <!-- READ_FL 'Y'로 변경 -->
  <update id="updateReadFlag">
    UPDATE HELP_MESSAGE
    SET MESSAGE_READ_FL = 'Y'
    WHERE MESSAGE_NO = #{messageNo}
  </update>

  <!-- 답변 여부 'Y'로 변경 -->
  <update id="updateReplyYn">
    UPDATE HELP_MESSAGE
    SET REPLY_YN = 'Y'
    WHERE MESSAGE_NO = #{messageNo}
  </update>

  <!-- 미답변 메시지 목록 (관리자가 보낸 것 제외) -->
  <select id="selectUnansweredMessages">
  SELECT 
    hm.MESSAGE_NO,
    hm.MESSAGE_TITLE,
    hm.MESSAGE_CONTENT,
    hm.MESSAGE_WRITE_DATE,
    hm.MESSAGE_READ_FL,
    hm.USER_DEL_FL,
    hm.ADMIN_DEL_FL,
    hm.SENDER_NO,
    hm.RECEIVER_NO,
    hm.REPLY_YN,
    NULL AS FILE_NO,
    NULL AS FILE_URL,
    NULL AS FILE_ORIGIN_NAME,
    NULL AS FILE_RENAME,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  WHERE hm.SENDER_NO != #{adminId}
    AND hm.REPLY_YN = 'N'
    AND hm.USER_DEL_FL = 'N'
    AND hm.ADMIN_DEL_FL = 'N'
  ORDER BY hm.MESSAGE_NO DESC
</select>


  <!-- 답변 완료된 메시지 (보낸 문의 중) -->
  <select id="selectAnsweredMessagesByUser">
  SELECT 
    hm.MESSAGE_NO,
    hm.MESSAGE_TITLE,
    hm.MESSAGE_CONTENT,
    hm.MESSAGE_WRITE_DATE,
    hm.MESSAGE_READ_FL,
    hm.USER_DEL_FL,
    hm.ADMIN_DEL_FL,
    hm.SENDER_NO,
    hm.RECEIVER_NO,
    hm.REPLY_YN,
    mf.FILE_NO,
    mf.FILE_URL,
    mf.FILE_ORIGIN_NAME,
    mf.FILE_RENAME,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  WHERE hm.INQUIRED_NO IS NOT NULL
    AND hm.SENDER_NO = #{userNo}
    AND hm.USER_DEL_FL = 'N'
    AND hm.ADMIN_DEL_FL = 'N'
  ORDER BY hm.MESSAGE_WRITE_DATE DESC
</select>



  <!-- 첨부파일 조회 -->
  <select id="selectFilesByMessageNo">
    SELECT 
      FILE_NO,
      MESSAGE_NO,
      FILE_URL,
      FILE_ORIGIN_NAME,
      FILE_RENAME
    FROM MESSAGE_FILE
    WHERE MESSAGE_NO = #{messageNo}
  </select>
  
  <!-- 함께 조회 -->
  <!-- 관리자가 특정 사용자에게 보낸 답변 리스트 조회 -->
<select id="selectRepliesByAdminToUser" >
    SELECT 
      hm.MESSAGE_NO,
      hm.MESSAGE_TITLE,
      hm.MESSAGE_CONTENT,
      TO_CHAR(hm.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS MESSAGE_WRITE_DATE,
      hm.MESSAGE_READ_FL,
      hm.USER_DEL_FL,
      hm.ADMIN_DEL_FL,
      hm.SENDER_NO,
      hm.RECEIVER_NO,
      hm.REPLY_YN,
      mf.FILE_NO,
      mf.FILE_URL,
      mf.FILE_ORIGIN_NAME,
      mf.FILE_RENAME
    FROM HELP_MESSAGE hm
    LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
    WHERE hm.SENDER_NO = #{adminNo}
      AND hm.RECEIVER_NO = #{userNo}
      AND hm.REPLY_YN = 'Y'
      AND hm.USER_DEL_FL = 'N'
      AND hm.ADMIN_DEL_FL = 'N'
    ORDER BY hm.MESSAGE_WRITE_DATE DESC
</select>

<!-- 수정 추가 -->
<update id="updateReplyContent">
    UPDATE HELP_MESSAGE
    SET MESSAGE_CONTENT = #{messageContent}
    WHERE MESSAGE_NO = #{messageNo}
      AND REPLY_YN = 'Y'
</update>

  

</mapper>
