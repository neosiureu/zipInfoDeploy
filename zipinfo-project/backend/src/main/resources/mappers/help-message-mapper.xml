<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zipinfo.project.admin.model.mapper.HelpMessageMapper">

<resultMap id="helpMessageResultMap" type="com.zipinfo.project.admin.model.dto.HelpMessage">
  <id property="messageNo" column="messageNo"/>
  <result property="messageTitle" column="messageTitle"/>
  <result property="messageContent" column="messageContent"/>
  <result property="messageWriteDate" column="messageWriteDate"/>
  <result property="senderNo" column="SENDER_NO"/>
  <result property="receiverNo" column="RECEIVER_NO"/>
  <result property="replyYn" column="REPLY_YN"/>
  <result property="fileNo" column="fileNo"/>
  <result property="fileUrl" column="fileUrl"/>
  <result property="fileOriginName" column="fileOriginName"/>
  <result property="fileRename" column="fileRename"/>
  <result property="replyContent" column="replyContent" />
</resultMap>

<select id="selectAllMessages">
  SELECT 
    MESSAGE_NO,
    MESSAGE_TITLE,
    MESSAGE_CONTENT,
    MESSAGE_WRITE_DATE,
    MESSAGE_READ_FL,
    USER_DEL_FL,
    ADMIN_DEL_FL,
    SENDER_NO,
    RECEIVER_NO,
    REPLY_YN,
    NULL AS FILE_NO,
    NULL AS FILE_URL,
    NULL AS FILE_ORIGIN_NAME,
    NULL AS FILE_RENAME
  FROM HELP_MESSAGE
  WHERE USER_DEL_FL = 'N'
  ORDER BY MESSAGE_NO DESC
</select>

<select id="selectMessageById">
  SELECT 
    hm.MESSAGE_NO AS messageNo,
    hm.MESSAGE_TITLE AS messageTitle,
    hm.MESSAGE_CONTENT AS messageContent,
     hm.REPLY_CONTENT AS replyContent,
    TO_CHAR(hm.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS messageWriteDate,
    hm.MESSAGE_READ_FL AS messageReadFl,
    hm.USER_DEL_FL AS userDelFl,
    hm.ADMIN_DEL_FL AS adminDelFl,
    hm.SENDER_NO AS senderNo,
    hm.RECEIVER_NO AS receiverNo,
    hm.REPLY_YN AS replyYn,
    hm.INQUIRED_NO AS inquiredNo,
    mf.FILE_NO AS fileNo,
    mf.FILE_URL AS fileUrl,
    mf.FILE_ORIGIN_NAME AS fileOriginName,
    mf.FILE_RENAME AS fileRename,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  WHERE hm.MESSAGE_NO = #{messageNo}
</select>

<!-- 답변 분리 조회 -->
<select id="selectReplyByInquiredNo">
  SELECT 
    hm.MESSAGE_NO AS messageNo,
    hm.MESSAGE_TITLE AS messageTitle,
    hm.MESSAGE_CONTENT AS messageContent,
    TO_CHAR(hm.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS messageWriteDate,
    hm.MESSAGE_READ_FL AS messageReadFl,
    hm.USER_DEL_FL AS userDelFl,
    hm.ADMIN_DEL_FL AS adminDelFl,
    hm.SENDER_NO AS senderNo,
    hm.RECEIVER_NO AS receiverNo,
    hm.REPLY_YN AS replyYn,
    hm.INQUIRED_NO AS inquiredNo,
    mf.FILE_NO AS fileNo,
    mf.FILE_URL AS fileUrl,
    mf.FILE_ORIGIN_NAME AS fileOriginName,
    mf.FILE_RENAME AS fileRename,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  WHERE hm.INQUIRED_NO = #{inquiredNo}
</select>


<insert id="insertReply">
  INSERT INTO HELP_MESSAGE (
    MESSAGE_NO, MESSAGE_TITLE, MESSAGE_CONTENT, MESSAGE_WRITE_DATE, MESSAGE_READ_FL,
    USER_DEL_FL, ADMIN_DEL_FL, REPLY_YN, SENDER_NO, RECEIVER_NO, INQUIRED_NO
  ) VALUES (
    SEQ_MESSAGE_NO.NEXTVAL, #{messageTitle}, #{messageContent}, SYSDATE, 'N', 'N', 'N', 'Y',
    #{senderNo}, #{receiverNo}, #{inquiredNo}
  )
</insert>

<update id="updateReadFlag">
  UPDATE HELP_MESSAGE
  SET MESSAGE_READ_FL = 'Y'
  WHERE MESSAGE_NO = #{messageNo}
</update>

<update id="updateReplyYn">
  UPDATE HELP_MESSAGE
  SET REPLY_YN = 'Y'
  WHERE MESSAGE_NO = #{messageNo}
</update>

<select id="selectUnansweredMessages">
  SELECT 
    hm.MESSAGE_NO, hm.MESSAGE_TITLE, hm.MESSAGE_CONTENT, hm.MESSAGE_WRITE_DATE,
    hm.MESSAGE_READ_FL, hm.USER_DEL_FL, hm.ADMIN_DEL_FL,
    hm.SENDER_NO, hm.RECEIVER_NO, hm.REPLY_YN,
    NULL AS FILE_NO, NULL AS FILE_URL, NULL AS FILE_ORIGIN_NAME, NULL AS FILE_RENAME,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  WHERE hm.SENDER_NO != #{adminId}
    AND hm.REPLY_YN = 'N'
    AND hm.USER_DEL_FL = 'N'
    AND hm.ADMIN_DEL_FL = 'N'
  ORDER BY hm.MESSAGE_NO DESC
</select>

<select id="selectAnsweredMessagesByUser">
  SELECT 
    hm.MESSAGE_NO, hm.MESSAGE_TITLE, hm.MESSAGE_CONTENT, hm.MESSAGE_WRITE_DATE,
    hm.MESSAGE_READ_FL, hm.USER_DEL_FL, hm.ADMIN_DEL_FL,
    hm.SENDER_NO, hm.RECEIVER_NO, hm.REPLY_YN,
    mf.FILE_NO, mf.FILE_URL, mf.FILE_ORIGIN_NAME, mf.FILE_RENAME,
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE hm
  LEFT JOIN MEMBER m ON hm.SENDER_NO = m.MEMBER_NO
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  WHERE hm.INQUIRED_NO IS NOT NULL
    AND hm.SENDER_NO = #{userNo}
    AND hm.USER_DEL_FL = 'N'
    AND hm.ADMIN_DEL_FL = 'N'
  ORDER BY hm.MESSAGE_WRITE_DATE DESC
</select>

<select id="selectRepliesByAdminToUser">
  SELECT 
    hm.MESSAGE_NO, hm.MESSAGE_TITLE, hm.MESSAGE_CONTENT,
    TO_CHAR(hm.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS messageWriteDate,
    hm.MESSAGE_READ_FL, hm.USER_DEL_FL, hm.ADMIN_DEL_FL,
    hm.SENDER_NO, hm.RECEIVER_NO, hm.REPLY_YN,
    mf.FILE_NO, mf.FILE_URL, mf.FILE_ORIGIN_NAME, mf.FILE_RENAME
  FROM HELP_MESSAGE hm
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  WHERE hm.SENDER_NO = #{adminNo}
    AND hm.RECEIVER_NO = #{userNo}
    AND hm.REPLY_YN = 'Y'
    AND hm.USER_DEL_FL = 'N'
    AND hm.ADMIN_DEL_FL = 'N'
  ORDER BY hm.MESSAGE_WRITE_DATE DESC
</select>


<select id="selectMessageWithReply" resultMap="helpMessageResultMap">
  SELECT
    m1.MESSAGE_NO AS messageNo,
    m1.INQUIRED_NO AS inquiredNo,
    m1.MESSAGE_TITLE AS messageTitle,
    m1.MESSAGE_CONTENT AS messageContent,
    TO_CHAR(m1.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS messageWriteDate,
    m1.SENDER_NO AS senderNo,
    m1.RECEIVER_NO AS receiverNo,
    m1.REPLY_YN AS replyYn,
    
    f.FILE_NO AS fileNo,
    f.FILE_URL AS fileUrl,
    f.FILE_ORIGIN_NAME AS fileOriginName,
    f.FILE_RENAME AS fileRename,
    
    m2.MESSAGE_CONTENT AS replyContent,
    
    m.MEMBER_NICKNAME AS memberNickname
  FROM HELP_MESSAGE m1
  LEFT JOIN MESSAGE_FILE f ON m1.MESSAGE_NO = f.MESSAGE_NO
  LEFT JOIN HELP_MESSAGE m2 ON m2.INQUIRED_NO = m1.MESSAGE_NO
  LEFT JOIN MEMBER m ON m1.SENDER_NO = m.MEMBER_NO
  WHERE m1.MESSAGE_NO = #{messageNo}
</select>



<select id="selectOriginalByReplyMessageNo">
  SELECT
    hm.MESSAGE_NO AS messageNo,
    hm.MESSAGE_TITLE AS messageTitle,
    hm.MESSAGE_CONTENT AS messageContent,
    TO_CHAR(hm.MESSAGE_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS messageWriteDate,
    hm.MESSAGE_READ_FL AS messageReadFl,
    hm.USER_DEL_FL AS userDelFl,
    hm.ADMIN_DEL_FL AS adminDelFl,
    hm.SENDER_NO AS senderNo,
    hm.RECEIVER_NO AS receiverNo,
    hm.REPLY_YN AS replyYn,
    mf.FILE_NO AS fileNo,
    mf.FILE_URL AS fileUrl,
    mf.FILE_ORIGIN_NAME AS fileOriginName,
    mf.FILE_RENAME AS fileRename
  FROM HELP_MESSAGE hm
  LEFT JOIN MESSAGE_FILE mf ON hm.MESSAGE_NO = mf.MESSAGE_NO
  WHERE hm.MESSAGE_NO = (
    SELECT INQUIRED_NO FROM HELP_MESSAGE WHERE MESSAGE_NO = #{replyMessageNo}
  )
</select>

</mapper>