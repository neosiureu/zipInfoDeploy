<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zipinfo.project.admin.model.mapper.HelpMessageMapper">

  <!-- 
    전체 문의 목록 조회 
    조건: 사용자/관리자 삭제되지 않은 문의만 조회 
    결과 매핑: HelpMessage DTO
  -->
  <select id="selectAllMessages" resultType="com.zipinfo.project.admin.model.dto.HelpMessage">
    SELECT 
      MESSAGE_NO,
      MESSAGE_TITLE,
      MESSAGE_CONTENT,
      MESSAGE_WRITE_DATE,
      MESSAGE_READ_FL,
      USER_DEL_FL,
      ADMIN_DEL_FL,
      SENDER_NO,
      RECEIVER_NO,
      INQUIRED_NO
    FROM HELP_MESSAGE
    WHERE USER_DEL_FL = 'N' AND ADMIN_DEL_FL = 'N'
    ORDER BY MESSAGE_NO DESC
  </select>

  <!-- 
    특정 문의 상세 조회 
    파라미터: messageNo (문의글 번호)
    결과 매핑: HelpMessage DTO
  -->
  <!-- 특정 메시지 상세 조회 -->
<select id="selectMessageById" parameterType="Integer" resultType="com.zipinfo.project.admin.model.dto.HelpMessage">
  SELECT 
    MESSAGE_NO,
    MESSAGE_TITLE,
    MESSAGE_CONTENT,
    MESSAGE_WRITE_DATE,
    MESSAGE_READ_FL,
    USER_DEL_FL,
    ADMIN_DEL_FL,
    SENDER_NO,
    RECEIVER_NO,
    INQUIRED_NO
  FROM HELP_MESSAGE
  WHERE MESSAGE_NO = #{messageNo}
</select>


  <!-- 
    답변 등록용 매퍼
    기능: 특정 문의글(MESSAGE_NO)에 대해 답변 내용(REPLY_CONTENT)과 날짜(REPLY_DATE) 저장,
         그리고 답변 완료 표시(INQUIRED_NO = 1)로 업데이트

    parameterType: map 또는 @Param("messageNo", "replyContent") 방식
    반환값: 업데이트된 행 수 (성공 시 1)
  -->
  
  <insert id="insertReply">
  	INSERT INTO "HELP_MESSAGE"
  	VALUES(SEQ_MESSAGE_NO.NEXTVAL,1,#{messageContent},SYSDATE, 'N','N','N', #{senderNo}, #{receiverNo},'N', #{inquiredNo})
  </insert>

<!-- 관리자가 문의내용 확인했을 경우 DB에 해당 문의글 READ_FL 'Y'로 변경

 -->
	<update id="updateReadFlag" parameterType="int">
	  UPDATE HELP_MESSAGE
	  SET READ_FL = 'Y'
	  WHERE MESSAGE_NO = #{messageNo}
	</update>
	
	<!-- 답변 등록 시 해당 문의글 REPLY_YN = 'Y'로 변경 -->
	<update id="updateReplyYn" parameterType="int">
	  UPDATE HELP_MESSAGE
	  SET REPLY_YN = 'Y'
	  WHERE MESSAGE_NO = #{messageNo}
	</update>
	
	<!-- 관리자가 보낸 메시지 제외 -->
	<select id="selectUnansweredMessages" resultType="com.zipinfo.project.admin.model.dto.HelpMessage">
  SELECT * FROM HELP_MESSAGE
  WHERE SENDER_NO != #{adminId}
    AND REPLY_YN = 'N'
    AND USER_DEL_FL = 'N'
    AND ADMIN_DEL_FL = 'N'
  ORDER BY MESSAGE_NO DESC
</select>

<!-- [보낸 문의] → [문의 답변] 메뉴: REPLY_YN = 'Y' 인 문의글만 출력 -->
<select id="selectAnsweredMessagesByUser" parameterType="int" resultType="com.zipinfo.project.admin.model.dto.HelpMessage">
  SELECT * FROM HELP_MESSAGE
  WHERE SENDER_NO = #{userNo}
    AND REPLY_YN = 'Y'
    AND USER_DEL_FL = 'N'
  ORDER BY MESSAGE_NO DESC
</select>


</mapper>
