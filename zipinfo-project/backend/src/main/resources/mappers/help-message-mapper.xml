<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zipinfo.project.admin.model.mapper.HelpMessageMapper">

  <!-- 전체 문의 목록 조회 -->
  <select id="selectAllMessages">
  SELECT 
    MESSAGE_NO,
    MESSAGE_TITLE,
    MESSAGE_CONTENT,
    MESSAGE_WRITE_DATE,
    MESSAGE_READ_FL,
    USER_DEL_FL,
    ADMIN_DEL_FL,
    SENDER_NO,
    RECEIVER_NO,
    REPLY_YN,
    NULL AS FILE_NO,
    NULL AS FILE_URL,
    NULL AS FILE_ORIGIN_NAME,
    NULL AS FILE_RENAME
  FROM HELP_MESSAGE
  WHERE USER_DEL_FL = 'N' 
  ORDER BY MESSAGE_NO DESC
</select>

  <!-- 특정 문의 상세 조회 -->
    <!-- 특정 문의 상세 조회 (첨부파일 필드 포함) -->
  <select id="selectMessageById">
    SELECT 
    hm.MESSAGE_NO,
    hm.MESSAGE_TITLE,
    hm.MESSAGE_CONTENT,
    hm.MESSAGE_WRITE_DATE,
    hm.MESSAGE_READ_FL,
    hm.USER_DEL_FL,
    hm.ADMIN_DEL_FL,
    hm.SENDER_NO,
    hm.RECEIVER_NO,
    hm.REPLY_YN,
    hf.FILE_NO,
    hf.FILE_URL,
    hf.FILE_ORIGIN_NAME,
    hf.FILE_RENAME
	  FROM HELP_MESSAGE hm
	  LEFT JOIN MESSAGE_FILE hf ON hm.MESSAGE_NO = hf.MESSAGE_NO
	  WHERE hm.MESSAGE_NO = #{messageNo}
	</select>



  <!-- 답변 등록용 (INSERT) -->
  <insert id="insertReply">
    INSERT INTO HELP_MESSAGE (
      MESSAGE_NO,
      MESSAGE_TITLE,
      MESSAGE_CONTENT,
      MESSAGE_WRITE_DATE,
      MESSAGE_READ_FL,
      USER_DEL_FL,
      ADMIN_DEL_FL,
      REPLY_YN,
      SENDER_NO,
      RECEIVER_NO,
      INQUIRED_NO
    ) VALUES (
      SEQ_MESSAGE_NO.NEXTVAL,
      '답변',
      #{messageContent},
      SYSDATE,
      'N',
      'N',
      'N',
      'N',
      #{senderNo},
      #{receiverNo},
      #{inquiredNo}
    )
  </insert>

  <!-- READ_FL 'Y'로 변경 -->
  <update id="updateReadFlag">
    UPDATE HELP_MESSAGE
    SET MESSAGE_READ_FL = 'Y'
    WHERE MESSAGE_NO = #{messageNo}
  </update>

  <!-- 답변 여부 'Y'로 변경 -->
  <update id="updateReplyYn">
    UPDATE HELP_MESSAGE
    SET REPLY_YN = 'Y'
    WHERE MESSAGE_NO = #{messageNo}
  </update>

  <!-- 미답변 메시지 목록 (관리자가 보낸 것 제외) -->
  <select id="selectUnansweredMessages">
    SELECT 
    MESSAGE_NO,
    MESSAGE_TITLE,
    MESSAGE_CONTENT,
    MESSAGE_WRITE_DATE,
    MESSAGE_READ_FL,
    USER_DEL_FL,
    ADMIN_DEL_FL,
    SENDER_NO,
    RECEIVER_NO,
    REPLY_YN,
    NULL AS FILE_NO,
    NULL AS FILE_URL,
    NULL AS FILE_ORIGIN_NAME,
    NULL AS FILE_RENAME
  FROM HELP_MESSAGE
  WHERE SENDER_NO != #{adminId}
    AND REPLY_YN = 'N'
    AND USER_DEL_FL = 'N'
    AND ADMIN_DEL_FL = 'N'
  ORDER BY MESSAGE_NO DESC
</select>

  <!-- 답변 완료된 메시지 (보낸 문의 중) -->
  <select id="selectAnsweredMessagesByUser">
  SELECT 
    MESSAGE_NO,
    MESSAGE_TITLE,
    MESSAGE_CONTENT,
    MESSAGE_WRITE_DATE,
    MESSAGE_READ_FL,
    USER_DEL_FL,
    ADMIN_DEL_FL,
    SENDER_NO,
    RECEIVER_NO,
    REPLY_YN,
    NULL AS FILE_NO,
    NULL AS FILE_URL,
    NULL AS FILE_ORIGIN_NAME,
    NULL AS FILE_RENAME
  FROM HELP_MESSAGE
  WHERE SENDER_NO = #{userNo}
    AND REPLY_YN = 'Y'
    AND USER_DEL_FL = 'N'
  ORDER BY MESSAGE_NO DESC
</select>


  <!-- 첨부파일 조회 -->
  <select id="selectFilesByMessageNo">
    SELECT 
      FILE_NO,
      MESSAGE_NO,
      FILE_URL,
      FILE_ORIGIN_NAME,
      FILE_RENAME
    FROM MESSAGE_FILE
    WHERE MESSAGE_NO = #{messageNo}
  </select>

</mapper>
