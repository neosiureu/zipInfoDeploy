<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zipinfo.project.myPage.model.mapper.MyPageMapper">

	<select id="getMemberInfo">
		SELECT MEMBER_NO, MEMBER_NAME, MEMBER_NICKNAME, MEMBER_EMAIL, MEMBER_AUTH, MEMBER_LOCATION <if test="memberAuth eq 3">, COMPANY_NAME, COMPANY_LOCATION, PRESIDENT_NAME, BROKER_NO, PRESIDENT_PHONE</if>
		FROM MEMBER M
		<if test="memberAuth eq 3">
		JOIN BROKER_INFO B USING(MEMBER_NO)
		</if>
		WHERE MEMBER_NO = #{memberNo}
	</select>

	<update id="updateNormalInfo">
		UPDATE "MEMBER" SET
		MEMBER_NICKNAME = #{memberNickname},
		MEMBER_LOCATION = #{memberLocation}
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<update id="updateBrokerInfo">
		UPDATE "BROKER_INFO" SET
		COMPANY_NAME = #{companyName},
		COMPANY_LOCATION = #{companyLocation},
		PRESIDENT_NAME = #{presidentName},
		BROKER_NO = #{brokerNo},
		PRESIDENT_PHONE = #{presidentPhone}
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<select id="getMemberPassword">
		SELECT MEMBER_PW FROM "MEMBER"
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	<update id="updatePassword">
		UPDATE "MEMBER" SET
		MEMBER_PW = #{memberPw}
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<select id="checkNickname" resultType="java.lang.Integer">
		SELECT MEMBER_NO
		FROM "MEMBER"
		WHERE MEMBER_NICKNAME = #{memberNickname}
	</select>
	
	<select id="compareInfo">
		SELECT COMPANY_NAME, COMPANY_LOCATION, PRESIDENT_NAME, BROKER_NO, PRESIDENT_PHONE
		FROM "BROKER_INFO"
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	<update id="changeAuth">
		UPDATE "MEMBER" SET
		MEMBER_AUTH = 2
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<update id="withDraw">
		UPDATE "MEMBER" SET
		MEMBER_DEL_FL = 'Y'
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<insert id="addStock">
		INSERT INTO "STOCK_INFO"
		VALUES(SEQ_STOCK_INFO.NEXTVAL, #{memberNo}, #{stockName}, #{stockSellPrice}, #{stockManageFee}
		, #{stockFeeMonth}, #{stockInfo}, #{stockType}, #{stockForm}, #{exclusiveArea}, #{supplyArea}
		, #{currentFloor}, #{floorTotalCount}, #{roomCount}, #{bathCount}, #{stockDirection}, #{ableDate}
		, #{useApprovalDate}, SYSDATE, #{stockDetail}, #{stockAddress}, #{regionNo}, 'N')
	</insert>
	
	<insert id="addStockImg">
		INSERT INTO "STOCK_IMG"
		VALUES(SEQ_STOCK_IMG.NEXTVAL, #{stockNo}, #{i}, #{finalPath}, #{originalName}, #{rename})
	</insert>
	
	<select id="searchStockNo">
		SELECT STOCK_NO
		FROM (
 		   SELECT STOCK_NO
		    FROM STOCK_INFO
		    WHERE MEMBER_NO = #{memberNo}
		    ORDER BY STOCK_NO DESC
		)
		WHERE ROWNUM = 1
	</select>
	
	<insert id="addCoord">
		INSERT INTO "STOCK_COORD"
		VALUES(#{stockNo}, #{lat}, #{lng})
	</insert>
	
	<select id="getMyStock">
		SELECT * FROM "STOCK_INFO"
		WHERE MEMBER_NO = #{memberNo}
		ORDER BY STOCK_NO DESC
	</select>
	
	<select id="selectImgUrl">
		SELECT IMG_URL, IMG_ORIGIN_NAME FROM "STOCK_IMG"
		WHERE STOCK_NO = #{stockNo}
		ORDER BY IMG_ORDER
	</select>
	
	<select id="selectStockCoord">
		SELECT * FROM "STOCK_COORD"
		WHERE STOCK_NO = #{stockNo}
	</select>
	
	<delete id="deleteStockInfo">
		DELETE "STOCK_INFO"
		WHERE STOCK_NO = #{stockNo}
	</delete>
	
	<update id="updateStock">
		UPDATE "STOCK_INFO" SET
		STOCK_NAME = #{stockName},
		STOCK_SELL_PRICE = #{stockSellPrice},
		STOCK_MANAGE_FEE = #{stockManageFee},
		STOCK_FEE_MONTH = #{stockFeeMonth},
		STOCK_INFO = #{stockInfo},
		STOCK_TYPE = #{stockType},
		STOCK_FORM = #{stockForm},
		EXCLUSIVE_AREA = #{exclusiveArea},
		SUPPLY_AREA = #{supplyArea},
		CURRENT_FLOOR = #{currentFloor},
		FLOOR_TOTAL_COUNT = #{floorTotalCount},
		ROOM_COUNT = #{roomCount},
		BATH_COUNT = #{bathCount},
		STOCK_DIRECTION = #{stockDirection},
		ABLE_DATE = #{ableDate},
		USE_APPROVAL_DATE = #{useApprovalDate},
		STOCK_DETAIL = #{stockDetail},
		STOCK_ADDRESS = #{stockAddress},
		REGION_NO = #{regionNo}
		WHERE STOCK_NO = #{stockNo}
	</update>

	<update id="updateCoord">
		UPDATE "STOCK_COORD" SET
		LAT = #{lat},
		LNG = #{lng}
		WHERE STOCK_NO = #{stockNo}
	</update>
	
	<update id="updateTumbImg">
		UPDATE "STOCK_IMG" SET
			IMG_URL = #{finalPath},
			IMG_ORIGIN_NAME = #{originalName},
			IMG_RENAME = #{rename}
			WHERE IMG_ORDER = 0
			AND STOCK_NO = #{stockNo}
	</update>
	
	<update id="updateBalanceImg">
		UPDATE "STOCK_IMG" SET
			IMG_URL = #{finalPath},
			IMG_ORIGIN_NAME = #{originalName},
			IMG_RENAME = #{rename}
			WHERE IMG_ORDER = 1
			AND STOCK_NO = #{stockNo}
	</update>
	
	<update id="updateStockImg">
		UPDATE "STOCK_IMG" SET
			IMG_URL = #{finalPath},
			IMG_ORIGIN_NAME = #{originalName},
			IMG_RENAME = #{rename}
			WHERE STOCK_NO = #{stockNo}
			AND IMG_ORDER = #{stockOrder}
	</update>
	
	<select id="getStockImgCount">
		SELECT COUNT(*) FROM "STOCK_IMG"
		WHERE STOCK_NO = #{stockNo}
	</select>
	
	<delete id="deleteStockImg">
		DELETE "STOCK_IMG"
		WHERE STOCK_NO = #{stockNo}
		AND IMG_ORDER = #{stockOrder}
	</delete>
	
	<insert id="insertStockImg">
		INSERT INTO "STOCK_IMG"
		VALUES(SEQ_STOCK_IMG.NEXTVAL, #{stockNo}, #{stockOrder}, #{finalPath}, #{originalName}, #{rename})
	</insert>
	
	<select id="getSawStock">
		SELECT STOCK_NO FROM "STOCK_SAW"
		WHERE MEMBER_NO = #{memberNo}
		ORDER BY SAW_DATE DESC
	</select>
	
	<select id="getLikeStock">
		SELECT STOCK_NO FROM "LIKE_STOCK"
		WHERE MEMBER_NO = #{memberNo}
		ORDER BY LIKE_DATE DESC
	</select>
	
	<select id="getSawStockInfo">
		SELECT * FROM "STOCK_INFO"
		WHERE STOCK_NO = #{stockNo}
	</select>
	
	<select id="getMyPost">
		SELECT
		B.BOARD_NO,
		B.BOARD_TITLE,
		M.MEMBER_NICKNAME,
		B.READ_COUNT,
		B.BOARD_CONTENT,
		B.BOARD_SUBJECT AS boardSubject,
		B.MEMBER_NO AS
		memberNo,
		B.TOWN_NO AS townNo,
		M.MEMBER_NICKNAME,

		(
		SELECT COUNT(DISTINCT
		CL.COMMENT_NO)
		FROM "COMMENT" C
		JOIN "COMMENT_LIKE" CL ON CL.COMMENT_NO
		= C.COMMENT_NO
		WHERE C.BOARD_NO = B.BOARD_NO
		AND C.COMMENT_DEL_FL = 'N'
		) AS COMMENT_COUNT,

		(SELECT COUNT(*)
		FROM "LIKE" L
		WHERE L.BOARD_NO =
		B.BOARD_NO) AS LIKE_COUNT,

		(SELECT BT.TOWN_NAME
		FROM "BOARD_TOWN" BT
		WHERE BT.TOWN_NO = B.TOWN_NO) AS TOWN_NAME,

		(SELECT BC.CITY_NAME
		FROM
		"BOARD_CITY" BC
		WHERE BC.CITY_NO = (
		SELECT BT.CITY_NO
		FROM "BOARD_TOWN"
		BT
		WHERE BT.TOWN_NO = B.TOWN_NO
		)) AS CITY_NAME,
		(SELECT BC.CITY_NO
		FROM
		"BOARD_CITY" BC
		WHERE BC.CITY_NO = (
		SELECT BT.CITY_NO

		FROM "BOARD_TOWN"
		BT
		WHERE BT.TOWN_NO = B.TOWN_NO)) AS CITY_NO,
        <![CDATA[
        CASE 
          WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24/60  THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60*60) || '초 전'
          WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24     THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60)    || '분 전'
          WHEN SYSDATE - B.BOARD_WRITE_DATE < 1        THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24)       || '시간 전'
          WHEN SYSDATE - B.BOARD_WRITE_DATE < 30       THEN FLOOR( SYSDATE - B.BOARD_WRITE_DATE)           || '일 전'
          WHEN SYSDATE - B.BOARD_WRITE_DATE < 365      THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/30)       || '달 전'
          ELSE  FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/365)                                                 || '년 전'
        END
        ]]>
		AS BOARD_WRITE_DATE

		FROM "BOARD" B
		JOIN "MEMBER" M ON B.MEMBER_NO =
		M.MEMBER_NO

		WHERE B.BOARD_DEL_FL = 'N'
		AND M.MEMBER_DEL_FL = 'N'
		AND M.MEMBER_NO = #{memberNo}

		ORDER BY
		B.BOARD_NO DESC
	</select>
	
	<delete id="unlikeStock">
		DELETE "LIKE_STOCK"
		WHERE MEMBER_NO = #{memberNo}
		AND STOCK_NO = #{stockNo}
	</delete>
	
	<insert id="likeStock">
		INSERT INTO "LIKE_STOCK"
		VALUES(#{stockNo}, #{memberNo}, SYSDATE)
	</insert>
	
	<update id="updateSellN">
		UPDATE "STOCK_INFO" SET
		SELL_YN = 'N'
		WHERE STOCK_NO = #{stockNo}
	</update>
	
	<update id="updateSellY">
		UPDATE "STOCK_INFO" SET
		SELL_YN = 'Y'
		WHERE STOCK_NO = #{stockNo}
	</update>
	
	<select id="selectAuthMember">
		SELECT MEMBER_NO FROM "MEMBER"
		WHERE MEMBER_AUTH = 0
	</select>
	
	<insert id="sendMessageFile">
		INSERT INTO "MESSAGE_FILE"
		VALUES(SEQ_FILE_NO.NEXTVAL, #{messageNo}, #{finalPath}, #{originalName}, #{rename})
	</insert>
	
	<insert id="sendMessageContent">
		INSERT INTO "HELP_MESSAGE"
		VALUES(SEQ_MESSAGE_NO.NEXTVAL, #{messageTitle}, #{messageContent}, SYSDATE, 'N', 'N', 'N', #{senderNo}, #{receiverNo}, 'N',NULL)
	</insert>
	
	<select id="getMessageNo">
		SELECT MESSAGE_NO FROM "HELP_MESSAGE"
		WHERE SENDER_NO = #{senderNo}
		ORDER BY MESSAGE_NO DESC
		FETCH FIRST 1 ROWS ONLY
	</select>
	
	<select id="getMyMessage">
		SELECT * FROM "HELP_MESSAGE"
		WHERE SENDER_NO = #{memberNo}
		ORDER BY MESSAGE_NO DESC
	</select>
	
	<select id="getMessageContent">
		SELECT * FROM "HELP_MESSAGE"
		WHERE MESSAGE_NO = #{messageNo}
	</select>
	
	<select id="getInquiredMessage">
		SELECT * FROM "HELP_MESSAGE"
		WHERE INQUIRED_NO = #{messageNo}
	</select>
	
	<select id="getMessageFile">
		SELECT * FROM "MESSAGE_FILE"
		WHERE MESSAGE_NO = #{messageNo}
	</select>
	
</mapper>
